<?xml version="1.0" encoding="utf-8"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/"><channel><title>Posts about Virtualization</title><link>https://chriswarrick.com/</link><atom:link href="https://chriswarrick.com/blog/tags/virtualization.xml" rel="self" type="application/rss+xml" /><description>A rarely updated blog, mostly about programming.</description><lastBuildDate>Sat, 30 Jan 2021 23:30:00 GMT</lastBuildDate><generator>https://github.com/Kwpolska/YetAnotherBlogGenerator</generator><item><title>Enabling Virtualization Support in Boot Camp with rEFInd</title><dc:creator>Chris Warrick</dc:creator><link>https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/</link><pubDate>Sat, 30 Jan 2021 23:30:00 GMT</pubDate><guid>https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/</guid><description>
You installed Windows on an Intel Mac via Boot Camp, and want to use
virtualization in it. But there’s an issue — hardware virtualization extensions
are not available. Luckily, this can be worked around easily with the help of
rEFInd, an alternate boot manager.
</description><content:encoded><![CDATA[
<p>You installed Windows on an Intel Mac via Boot Camp, and want to use
virtualization in it. But there’s an issue — hardware virtualization extensions
are not available. Luckily, this can be worked around easily with the help of
rEFInd, an alternate boot manager.</p>



<p>Many software development workflows involve virtualization. WSL, Docker for
Windows, and the Android Emulator are some examples of common
virtualization-based tools. Then there are general virtualization
tools/hypervisors, such as VMware Workstation, Hyper-V or VirtualBox. All these
tools require hardware virtualization extensions (Intel VT-x, AMD-V) or at
least are very slow without them. Virtualization extensions are not enabled by
default in the CPU, they must be enabled by something. On typical PCs, this is
often a firmware-level setting (that might be disabled by default), or it might
be unconditionally enabled by the firmware. On a Mac, however, enabling VT-x is
done by macOS, as part of the boot process. This means that Windows running in
Boot Camp will start without virtualization, unless you want to boot into macOS
first and then reboot into Windows. That setup isn’t quite ergonomic (and what
if macOS refuses to shut down, as it often does for me?).</p>
<p>Instead, we’re going to use
<a class="reference external" href="https://www.rodsbooks.com/refind/">rEFInd</a>, a boot manager for
EFI-based systems that can boot into various OSes and also handle other
parts of the boot process. But first, let’s prepare our system for this.</p>
<p class="lead"><strong>DISCLAIMER:</strong> Those steps may make your Mac fail to boot. I don’t take any
responsibility whatsoever if that happens. Prepare for the worst — make
backups, perhaps have install media ready, plan some downtime.</p>
<section id="step-1-install-windows-in-boot-camp-the-usual-way">
<h1>Step 1. Install Windows in Boot Camp the usual way</h1>
<p>The first thing you should do is install Windows 10 in Boot Camp, with
the help of the Boot Camp Assistant. The Assistant will take some time
to partition your drive and do other preparations (and show barely
informative progress bars, but <a class="reference external" href="https://chriswarrick.com/blog/2020/06/03/reinstalling-macos-what-to-try-when-all-else-fails/#an-open-letter-to-progress-bar-designers">I ranted about that Apple design “feature”
already</a>).
There are no special preparations for this, the standard process will
work. If you already have Windows installed, you can go to the next
step.</p>
</section>
<section id="step-2-ensure-the-setup-is-stable">
<h1>Step 2. Ensure the setup is stable</h1>
<p>We’ll be making changes to how the machine boots, and as such, it’s
good to have other things working correctly and in line with your
expected configuration. Make sure that:</p>
<ul class="simple">
<li><p>Both macOS and Windows boot correctly</p></li>
<li><p>You can change the OS you boot into by holding the Option key after
pressing Power (requires disabling the firmware password <a class="brackets" href="https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/#footnote-1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>)</p></li>
<li><p>Disk encryption (FileVault, BitLocker) is enabled (if you want that, of
course) and fully configured (initial encryption is complete)</p></li>
<li><p>Windows setup (including Boot Camp drivers) is complete</p></li>
<li><p>The <code class="docutils literal">OSXRESERVED</code> partition that the Boot Camp Assistant created
has been deleted (that should have happened when booting into macOS for the
first time after installing Windows — complete with a slowly moving
progress bar and no other information, as is usual for this OS — but
if that didn’t happen, use Disk Utility in macOS or Recovery OS to do
that — pick your drive, click <em>Partition</em> and delete the partition,
this will grow the macOS partition)</p></li>
<li><p>System Integrity Protection is enabled (the procedure is a bit safer
that way)</p></li>
</ul>
</section>
<section id="step-3-create-a-partition-for-refind">
<h1>Step 3. Create a partition for rEFInd</h1>
<p>First, back up your data before making changes to your hard drive
layout. We’ll need to create a new partition for rEFInd to live on. This
is the safest option — you could install it to the EFI System Partition (ESP),
but macOS might want to put its own stuff there, and it’s safer not to
use it.</p>
<p>The rEFInd partition doesn’t need to be large (50 MB will be enough); it must use the HFS+ (Mac OS
Extended) file system. To create it, you have three options:</p>
<ul class="simple">
<li><p>From macOS, by shrinking the macOS partition: open Disk Utility,
choose your drive, select Partition, add a new partition, set its
size and file system (in that order!). This will take a few minutes
(10-15, or possibly more), and you won’t be able to use your Mac
during the resize.</p></li>
<li><p>From Recovery OS, by shrinking the macOS partition: same steps apply,
but it might be a bit safer than doing it from within macOS.</p></li>
<li><p>From Windows, by shrinking the Windows partition: open Disk
Management (press the Windows key and type <em>partition</em>, or open
Computer Management from Administrative Tools), right click your
Windows partition, select Shrink Volume. Enter the desired size and
click Shrink. Then, right click the unallocated space and create a
New Simple Volume. For now, choose FAT32 or exFAT; you’ll need to
reformat it as HFS+ from within macOS later (<em>Erase</em> in Disk Utility). This
will take a few seconds — and even if you include the time to reboot, it’s
faster.</p></li>
</ul>
<p>After you create the new partition and make sure it’s HFS+ (Mac OS
Extended), you can proceed with the setup. Also, if you don’t want the
partition to be visible in the Finder, run the following command (insert
the correct volume path for your system):</p>
<div class="code"><pre class="code text"><a id="rest_code_c10cbc8d5f0c4516bc298e5b3e0b15b5-1" name="rest_code_c10cbc8d5f0c4516bc298e5b3e0b15b5-1" href="https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/#rest_code_c10cbc8d5f0c4516bc298e5b3e0b15b5-1"></a>sudo chflags hidden /Volumes/rEFInd
</pre></div>
</section>
<section id="step-4-configure-and-install-refind">
<h1>Step 4. Configure and install rEFInd</h1>
<p>To set ue rEFInd, you’ll need to boot into macOS. <a class="reference external" href="https://www.rodsbooks.com/refind/getting.html">Download
rEFInd</a> from the
author’s website — you want the file named <em>A binary zip file</em>. Extract
this archive anywhere on your system (<code class="docutils literal">~/Downloads</code> is fine).</p>
<p>First, you’ll need to change the configuration file
<code class="docutils literal"><span class="pre">refind/refind.conf-sample</span></code>. Locate the setting named
<code class="docutils literal">enable_and_lock_vmx</code>, uncomment it (remove the <code class="docutils literal">#</code> at the start
of the line), and set its value to <code class="docutils literal">true</code>. You can also make other
configuration changes — the default <code class="docutils literal">timeout</code> of 20 seconds is
likely to be too much for your needs.</p>
<p>When your configuration file is ready, you can install rEFInd. You can
use the <code class="docutils literal"><span class="pre">refind-install</span></code> tool, or perform a manual install (check
out the <a class="reference external" href="https://www.rodsbooks.com/refind/installing.html">installation
docs</a> for more
details).</p>
<p>Before installing, you’ll need to get the device name of your rEFInd
partition. Open Disk Utility, select the partition from the left pane,
and check the <em>Device</em> field (for example, <code class="docutils literal">disk9s9</code> — it will be
<strong>different</strong> on your system, depending on your partition layout).</p>
<p>Open a Terminal, <code class="docutils literal">cd</code> into the directory where rEFInd was extracted,
and run the following command (replace <code class="docutils literal">disk9s9</code> with the device
name on your system):</p>
<div class="code"><pre class="code text"><a id="rest_code_d3a775e9f58d45929b57a28925faec5e-1" name="rest_code_d3a775e9f58d45929b57a28925faec5e-1" href="https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/#rest_code_d3a775e9f58d45929b57a28925faec5e-1"></a>./refind-install --ownhfs disk9s9
</pre></div>
<p>This command will produce an error if you have SIP enabled — but this
error is not important for us, the install will work without the change
that SIP prevented. <a class="brackets" href="https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/#footnote-2" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p>
<p>You can now shut down your Mac and use the Option key while starting up
to choose the OS. You should see three options: Macintosh HD, EFI Boot,
and Boot Camp. The EFI Boot option is rEFInd — pick that, boot into
Windows (Microsoft EFI boot), <em>et voilà</em> — Windows can now run virtualization software.</p>
<p>There are a few more things that you can do now, depending on your OS
preferences.</p>
<ul class="simple">
<li><p>You can make rEFInd the default boot loader. Hold <em>Control</em> on the
Apple boot device selection screen and click the Power icon under the
EFI Boot drive (<a class="reference external" href="https://apple.stackexchange.com/a/73742">source for the
tip</a>).</p></li>
<li><p>You can use rEFInd to boot into macOS, although this might not work
with Big Sur according to the author (it seems to work for me, but
YMMV). You can use the standard boot method for macOS (by defaulting
to Macintosh HD, or by choosing it from the Power+Option picker) and
rEFInd exclusively for Windows (and set your timeout to a low value).</p></li>
<li><p>You can modify rEFInd’s configuration — in this scenario, the config
file is <code class="docutils literal">/Volumes/rEFInd/System/Library/CoreServices/refind.conf</code>.
You can set a custom background image, for example (<a class="reference external" href="https://www.rodsbooks.com/refind/">rEFInd’s
site</a> can help you figure out
what options are available and what you can set them to).</p></li>
</ul>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="footnote-1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>If the firmware password is important to you, you can restore it after
the setup is done — this will mean using rEFInd to boot both Windows and
macOS, although I decided to remove the firmware password and boot
into macOS from the Power+Option boot menu.</p>
</aside>
<aside class="footnote brackets" id="footnote-2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="https://chriswarrick.com/blog/2021/01/31/enabling-virtualization-support-in-boot-camp-with-refind/#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>The failing operation is marking the rEFInd partition bootable in the Mac
sense, using the <code class="docutils literal">bless</code> command. However, the drive is considered
bootable as an EFI-compliant boot volume (it has <code class="docutils literal">*.efi</code> files in specific
places), and this is the boot method we’re using here. SIP aside, the
<code class="docutils literal">bless</code> utility is a bit buggy, and we can use rEFInd without a blessed
partition just fine.</p>
</aside>
</aside>
</section>
]]></content:encoded><category>Apple</category><category>Boot Camp</category><category>Mac</category><category>rEFInd</category><category>Virtualization</category><category>Windows</category></item></channel></rss>